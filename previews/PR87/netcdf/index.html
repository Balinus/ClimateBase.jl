<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>NetCDF IO · ClimateBase</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><script src="../../copy.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="https://fonts.googleapis.com/css?family=Quicksand|Montserrat|Source+Code+Pro|Lora&amp;display=swap" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimateBase</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Introduction</a></li><li class="is-active"><a class="tocitem" href>NetCDF IO</a><ul class="internal"><li><a class="tocitem" href="#Read"><span>Read</span></a></li><li><a class="tocitem" href="#Write"><span>Write</span></a></li><li><a class="tocitem" href="#xarray"><span>xarray</span></a></li><li><a class="tocitem" href="#Ensemble-types"><span>Ensemble types</span></a></li></ul></li><li><a class="tocitem" href="../statistics/">Statistics</a></li><li><a class="tocitem" href="../plotting/">Plotting</a></li><li><a class="tocitem" href="../advanced/">Advanced functionality</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>NetCDF IO</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>NetCDF IO</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaClimate/ClimateBase.jl/blob/master/docs/src/netcdf.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="NetCDF-IO"><a class="docs-heading-anchor" href="#NetCDF-IO">NetCDF IO</a><a id="NetCDF-IO-1"></a><a class="docs-heading-anchor-permalink" href="#NetCDF-IO" title="Permalink"></a></h1><p>ClimateBase.jl has support for <code>&quot;file.nc&quot; ⇆ ClimArray</code>. Usually this is done using NCDatasets.jl, but see below for a function that translates a loaded <code>xarray</code> (from Python) into <code>ClimArray</code>.</p><h2 id="Read"><a class="docs-heading-anchor" href="#Read">Read</a><a id="Read-1"></a><a class="docs-heading-anchor-permalink" href="#Read" title="Permalink"></a></h2><p>To load a <code>ClimArray</code> directly from an <code>.nc</code> file do:</p><article class="docstring"><header><a class="docstring-binding" id="ClimateBase.ncread" href="#ClimateBase.ncread"><code>ClimateBase.ncread</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ncread(file, var [, selection]; kwargs...) → A</code></pre><p>Load the variable <code>var</code> from the <code>file</code> and convert it into a <a href="../#ClimateBase.ClimArray-Tuple{AbstractArray, Tuple}"><code>ClimArray</code></a> with proper dimension mapping and also containing the variable attributes as a dictionary. Dimension attributes are also given to the dimensions of <code>A</code>, if any exist.  See keywords below for specifications for unstructured grids.</p><p><code>file</code> can be a string to a <code>.nc</code> file. Or, it can be an <code>NCDataset</code>, which allows you to lazily combine different <code>.nc</code> data (typically split by time), e.g.</p><pre><code class="language-julia hljs">using Glob # for getting all files
alldata = glob(&quot;toa_fluxes_*.nc&quot;)
file = NCDataset(alldata; aggdim = &quot;time&quot;)
A = ClimArray(file, &quot;tow_sw_all&quot;)</code></pre><p><code>var</code> is a <code>String</code> denoting which variable to load. For <code>.nc</code> data containing groups <code>var</code> can also be a tuple <code>(&quot;group_name&quot;, &quot;var_name&quot;)</code> that loads a specific variable from a specific group. In this case, the attributes of both the group and the CF-variable are attributed to the created <a href="../#ClimateBase.ClimArray-Tuple{AbstractArray, Tuple}"><code>ClimArray</code></a>.</p><p>Optionally you can provide a <code>selection</code> for selecting a smaller part of the full array. The <code>selection</code> must be a tuple of indices that compose the selection and you must specify exactly as many ranges as the dimensions of the array and in the correct order. For example, if <code>var</code> corresponds to an array with three dimensions, such syntaxes are possible:</p><pre><code class="language-julia hljs">(:, :, 1:3)
(1:5:100, 1:1, [1,5,6])</code></pre><p>The function <a href="#ClimateBase.ncsize"><code>ncsize</code></a> can be useful for <code>selection</code>.</p><p>See also <a href="#ClimateBase.ncdetails"><code>ncdetails</code></a>, <a href="#ClimateBase.nckeys"><code>nckeys</code></a> and <a href="#ClimateBase.ncwrite"><code>ncwrite</code></a>.</p><p><strong>Smart loading</strong></p><p>The following things make loading data with <code>ncread</code> smarter than directly trying to use NCDatasets.jl and then convert to some kind of dimensional container.</p><ol><li>Data are directly transformed into <code>ClimArray</code>, conserving metadata and dimension names.</li><li>If there are no missing values in the data (according to CF standards), the returned array is automatically converted to a concrete type (i.e. <code>Union{Float32, Missing}</code> becomes <code>Float32</code>).</li><li>Dimensions that are ranges (i.e. sampled with constant step size) are automatically transformed to a standard Julia <code>Range</code> type (which makes sub-selecting faster).</li><li>Automatically deducing whether the spatial information is in an orthogonal grid or not, and creating a single <code>Coord</code> dimension if not.</li></ol><p><strong>Keywords</strong></p><ul><li><code>name</code> optionally rename loaded array.</li><li><code>grid = nothing</code> optionally specify whether the underlying grid is <code>grid = OrthogonalSpace()</code> or <code>grid = CoordinateSpace()</code>, see <a href="../statistics/#Types-of-spatial-information">Types of spatial information</a>. If <code>nothing</code>, we try to deduce automatically based on the names of dimensions and other keys of the <code>NCDataset</code>.</li><li><code>lon, lat</code>. These two keywords are useful in unstructured grid data where the grid information is provided in a <em>separate .nc file</em>. What we need is the user to provide vectors of the central longitude and central latitude of each grid point. This is done e.g. by<pre><code class="language-julia hljs">ds = NCDataset(&quot;path/to/grid.nc&quot;);
lon = Array(ds[&quot;clon&quot;]);
lat = Array(ds[&quot;clat&quot;]);</code></pre>If <code>lon, lat</code> are given, <code>grid</code> is automatically assumed <code>CoordinateSpace()</code>.</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaClimate/ClimateBase.jl/blob/52f2df2a59cba194ae762f9d0201cb33624b812c/src/core/nc_io.jl#L66-L130">source</a></section></article><p>Notice that (at the moment) we use a pre-defined mapping of common names to proper dimensions - please feel free to extend the following via a Pull Request:</p><pre><code class="language-julia hljs">ClimateBase.COMMONNAMES</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Dict{String, UnionAll} with 16 entries:
  &quot;lat&quot;       =&gt; Lat
  &quot;altitude&quot;  =&gt; Hei
  &quot;time&quot;      =&gt; Ti
  &quot;pressure&quot;  =&gt; Pre
  &quot;xc&quot;        =&gt; Lon
  &quot;x&quot;         =&gt; Lon
  &quot;lon&quot;       =&gt; Lon
  &quot;age&quot;       =&gt; Ti
  &quot;level&quot;     =&gt; Pre
  &quot;latitude&quot;  =&gt; Lat
  &quot;height&quot;    =&gt; Hei
  &quot;long&quot;      =&gt; Lon
  &quot;longitude&quot; =&gt; Lon
  &quot;t&quot;         =&gt; Ti
  &quot;yc&quot;        =&gt; Lat
  &quot;y&quot;         =&gt; Lat</code></pre><p>Also, the following convenience functions are provided for examining the content of on-disk <code>.nc</code> files without loading all data on memory.</p><article class="docstring"><header><a class="docstring-binding" id="ClimateBase.nckeys" href="#ClimateBase.nckeys"><code>ClimateBase.nckeys</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">nckeys(file::String)</code></pre><p>Return all keys of the <code>.nc</code> file in <code>file</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaClimate/ClimateBase.jl/blob/52f2df2a59cba194ae762f9d0201cb33624b812c/src/core/nc_io.jl#L20-L23">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimateBase.ncdetails" href="#ClimateBase.ncdetails"><code>ClimateBase.ncdetails</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ncdetails(file, io = stdout)</code></pre><p>Print details about the <code>.nc</code> file in <code>file</code> on <code>io</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaClimate/ClimateBase.jl/blob/52f2df2a59cba194ae762f9d0201cb33624b812c/src/core/nc_io.jl#L31-L34">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimateBase.ncsize" href="#ClimateBase.ncsize"><code>ClimateBase.ncsize</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ncsize(file, var)</code></pre><p>Return the size of the variable of the <code>.nc</code> file without actually loading any data.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaClimate/ClimateBase.jl/blob/52f2df2a59cba194ae762f9d0201cb33624b812c/src/core/nc_io.jl#L42-L45">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ClimateBase.globalattr" href="#ClimateBase.globalattr"><code>ClimateBase.globalattr</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">globalattr(file::String) → Dict</code></pre><p>Return the global attributes of the .nc file.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaClimate/ClimateBase.jl/blob/52f2df2a59cba194ae762f9d0201cb33624b812c/src/core/nc_io.jl#L53-L56">source</a></section></article><h2 id="Write"><a class="docs-heading-anchor" href="#Write">Write</a><a id="Write-1"></a><a class="docs-heading-anchor-permalink" href="#Write" title="Permalink"></a></h2><p>You can also write a bunch of <code>ClimArray</code>s directly into an <code>.nc</code> file with</p><article class="docstring"><header><a class="docstring-binding" id="ClimateBase.ncwrite" href="#ClimateBase.ncwrite"><code>ClimateBase.ncwrite</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ncwrite(file::String, Xs; globalattr = Dict())</code></pre><p>Write the given <code>ClimArray</code> instances (any iterable of <code>ClimArray</code>s or a single <code>ClimArray</code>) to a <code>.nc</code> file following CF standard conventions using NCDatasets.jl. Optionally specify global attributes for the <code>.nc</code> file.</p><p>The metadata of the arrays in <code>Xs</code>, as well as their dimensions, are properly written in the <code>.nc</code> file and any necessary type convertions happen automatically.</p><p><strong>WARNING</strong>: We assume that any dimensions shared between the <code>Xs</code> are identical.</p><p>See also <a href="#ClimateBase.ncread"><code>ncread</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaClimate/ClimateBase.jl/blob/52f2df2a59cba194ae762f9d0201cb33624b812c/src/core/nc_io.jl#L454-L466">source</a></section></article><h2 id="xarray"><a class="docs-heading-anchor" href="#xarray">xarray</a><a id="xarray-1"></a><a class="docs-heading-anchor-permalink" href="#xarray" title="Permalink"></a></h2><p>You can use the following functions (which are not defined and exported in <code>ClimateBase</code> to avoid dependency on PyCall.jl) to load data using Python&#39;s <code>xarray</code>.</p><pre><code class="language-julia hljs">using ClimateBase, Dates
# This needs to numpy, xarray and dask installed from Conda
using PyCall
xr = pyimport(&quot;xarray&quot;)
np = pyimport(&quot;numpy&quot;)

function climarray_from_xarray(xa, fieldname, name = fieldname)
    w = getproperty(xa, Symbol(fieldname))
    raw_data = Array(w.values)
    dnames = collect(w.dims) # dimensions in string name
    dim_values, dim_attrs = extract_dimension_values_xarray(xa, dnames)
    @assert collect(size(raw_data)) == length.(dim_values)
    actual_dims = create_dims_xarray(dnames, dim_values, dim_attrs)
    ca = ClimArray(raw_data, actual_dims, name; attrib = w.attrs)
end

function extract_dimension_values_xarray(xa, dnames = collect(xa.dims))
    dim_values = []
    dim_attrs = Vector{Any}(fill(nothing, length(dnames)))
    for (i, d) in enumerate(dnames)
        dim_attrs[i] = getproperty(xa, d).attrs
        x = getproperty(xa, d).values
        if d ≠ &quot;time&quot;
            push!(dim_values, x)
        else
            # Dates need special handling to be transformed into `DateTime`.
            dates = [np.datetime_as_string(y)[1:19] for y in x]
            dates = DateTime.(dates)
            push!(dim_values, dates)
        end
    end
    return dim_values, dim_attrs
end

function create_dims_xarray(dnames, dim_values, dim_attrs)
    true_dims = ClimateBase.to_proper_dimensions(dnames)
    optimal_values = ClimateBase.vector2range.(dim_values)
    out = []
    for i in 1:length(true_dims)
        push!(out, true_dims[i](optimal_values[i]; metadata = dim_attrs[i]))
    end
    return (out...,)
end

# Load some data
xa = xr.open_mfdataset(ERA5_files_path)
X = climarray_from_xarray(xa, &quot;w&quot;, &quot;optional name&quot;)</code></pre><h2 id="Ensemble-types"><a class="docs-heading-anchor" href="#Ensemble-types">Ensemble types</a><a id="Ensemble-types-1"></a><a class="docs-heading-anchor-permalink" href="#Ensemble-types" title="Permalink"></a></h2><p>A dedicated type representing ensembles has no reason to exist in ClimateBase.jl. As the package takes advantage of standard Julia datastructures and syntax, those can be used to represent &quot;ensembles&quot;. For example to do an &quot;ensemble global mean&quot; you can just do:</p><pre><code class="language-julia hljs"># load all data
E = [ClimArray(&quot;ensemble_$i.nc&quot;, &quot;x&quot;) for i in 1:10]
# mean from all data
global_mean = mean(spacemean(X) for X in E)</code></pre><p>where you see that the &quot;ensemble&quot; was represented just as a <code>Vector{ClimArray}</code>. Of course, this requires that all data can fit into memory, but this is so far the only way ClimateBase.jl operates anyways.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Introduction</a><a class="docs-footer-nextpage" href="../statistics/">Statistics »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.12 on <span class="colophon-date" title="Tuesday 25 January 2022 12:31">Tuesday 25 January 2022</span>. Using Julia version 1.7.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
